# BuzzInMap - 基于地图的实时社交小程序

这是一个基于微信小程序云开发的地图社交应用，支持用户实时定位、地图互动和社交功能。用户可以在地图上发布和查看附近的状态信息，实现基于地理位置的社交互动。

## 项目状态

当前版本：v0.2.1
开发阶段：基础功能开发中

### 已完成功能
- ✅ 实时定位：精确获取用户当前位置
- ✅ 地图显示：使用高德地图 SDK 显示位置信息
- ✅ 地址解析：自动将经纬度转换为可读地址
- ✅ 状态发布：支持在当前位置发布文字状态
- ✅ 云开发集成：使用微信云开发能力，支持数据存储
- ✅ 用户认证：完整的微信登录和用户信息获取流程
- ✅ 模拟器支持：支持在开发者工具中使用模拟数据进行测试

### 进行中功能
- 🔄 附近状态展示：在地图上显示附近的状态信息
- 🔄 状态交互：点击地图标记查看详细信息

### 计划功能
- 📅 状态评论和点赞
- 📅 用户个人主页
- 📅 消息通知系统
- 📅 图片和多媒体支持

## 技术架构

### 前端技术栈
- 微信小程序
- TypeScript
- 高德地图 SDK (amap-wx v1.3.0)
- ESLint (代码规范)

### 后端技术栈
- 微信云开发
  - 云函数
  - 云数据库
  - 云存储

## 环境要求

### 开发环境
- 微信开发者工具：最新版本
- Node.js：v12.0.0 或以上
- npm：v6.0.0 或以上

### 运行环境
- 基础库：3.6.5-16 或以上
- 支持多端开发模式
- 云开发环境：需要开通

## 项目配置

### 小程序配置
- AppID：wx0affc5549f662aac
- 项目类型：多端应用
- 编译类型：miniprogram

### 云开发配置
- 环境ID：milemala-wxcloud-4fymf8z296d18bf
- 云函数初始化：
  - 必须在 app.ts 中配置正确的 appid
  - 确保 wx.cloud.init() 包含完整配置：
    ```typescript
    wx.cloud.init({
      env: 'milemala-wxcloud-4fymf8z296d18bf',
      traceUser: true,
      appid: 'wx0affc5549f662aac'
    });
    ```
- 云函数：
  - login：用户登录认证
  - status：状态管理（发布、查询）

### 地图配置
- 高德地图 Key：c9656f7a27579dbdcba4957e1b7055a0
- 坐标系统：GCJ-02

## 数据库设计

### status 集合
```javascript
{
  _id: string,          // 状态ID
  title: string,        // 标题
  detail: string,       // 详细内容
  geoPoint: {          // 地理位置
    latitude: number,   // 纬度
    longitude: number   // 经度
  },
  address: string,      // 地址文本
  userId: string,       // 用户ID
  createTime: Date      // 创建时间
}
```

## 当前遗留问题

1. 云开发环境
   - 云函数权限验证问题（-501023错误）
   - 需要完善云函数错误处理机制

2. 地图功能
   - 标记显示可能存在延迟
   - 需要优化地图性能和交互体验

3. 数据存储
   - 需要建立数据索引优化查询性能
   - 考虑添加数据缓存机制

## 开发注意事项

### 多端开发
1. 导入项目时：
   - 选择多端应用模式
   - 关闭自动编译
   - 切换到多端应用模式后再编译

2. 基础库版本：
   - 确保使用 3.6.5 或以上版本
   - 注意多端兼容性问题

### 云开发
1. 云函数：
   - 部署前确保环境ID配置正确
   - 注意权限设置，特别是未登录用户访问限制
   - 使用 TypeScript 开发时注意编译配置

2. 数据库：
   - 使用经纬度范围查询实现位置搜索
   - 注意数据安全和访问控制
   - 合理设计数据结构，避免冗余

### 地图功能
1. 坐标系统：
   - 统一使用 GCJ-02 坐标系
   - 注意坐标转换和精度问题

2. 性能优化：
   - 合理控制地图刷新频率
   - 优化标记渲染机制
   - 考虑使用缓存减少服务器请求

## 部署流程

1. 云函数部署
```bash
# 部署所有云函数
./uploadCloudFunction.sh

# 单独部署特定云函数
cd cloudfunctions/[function-name]
npm install
```

2. 小程序发布
- 完成代码审核
- 确保云开发环境配置正确
- 提交审核前测试所有功能

## 贡献指南

1. 代码规范
- 使用 TypeScript 进行开发
- 遵循 ESLint 规范
- 保持统一的代码风格

2. 提交规范
- 使用清晰的提交信息
- 保持功能的独立性
- 及时同步主分支

## 更新日志

### v0.2.1 (2024-03-xx)
- 完善用户登录系统
- 添加模拟器支持
- 优化云函数初始化配置
- 修复云函数调用问题

### v0.2.0
- 添加状态发布功能
- 实现地图标记显示
- 优化云函数结构
- 完善错误处理机制

### v0.1.0
- 实现基础地图功能
- 添加位置定位
- 集成高德地图 SDK
- 建立云开发环境

## 联系方式

如有问题或建议，请提交 Issue 或 Pull Request

## 许可证

MIT License 

## 用户认证系统

### 登录流程
1. 应用启动时：
   - 检查云环境初始化
   - 验证用户登录状态
   - 自动恢复上次登录状态

2. 用户登录：
   - 支持微信一键登录
   - 获取用户基本信息
   - 生成唯一用户标识

3. 模拟器支持：
   - 开发环境下使用固定测试账号
   - 自动跳过云函数调用
   - 使用本地存储模拟登录状态

### 数据存储
```typescript
// 用户信息结构
interface UserInfo {
  nickName: string;     // 用户昵称
  avatarUrl: string;    // 头像URL
  gender: number;       // 性别
  country: string;      // 国家
  province: string;     // 省份
  city: string;         // 城市
  language: string;     // 语言
}

// 登录状态
interface LoginState {
  isLoggedIn: boolean;  // 是否已登录
  userId: string;       // 用户ID
  openid: string;       // 微信openid
}
``` 